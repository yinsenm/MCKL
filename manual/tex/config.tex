% ============================================================================
%  MCKL/manual/tex/config.tex
% ----------------------------------------------------------------------------
%  MCKL: Monte Carlo Kernel Library
% ----------------------------------------------------------------------------
%  Copyright (c) 2013-2017, Yan Zhou
%  All rights reserved.
%
%  Redistribution and use in source and binary forms, with or without
%  modification, are permitted provided that the following conditions are met:
%
%    Redistributions of source code must retain the above copyright notice,
%    this list of conditions and the following disclaimer.
%
%    Redistributions in binary form must reproduce the above copyright notice,
%    this list of conditions and the following disclaimer in the documentation
%    and/or other materials provided with the distribution.
%
%  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
%  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
%  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
%  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
%  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
%  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
%  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
%  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
%  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
%  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
%  POSSIBILITY OF SUCH DAMAGE.
% ============================================================================

\chapter{Configuration Macros}
\label{chap:Configuration Macros}

The library has a few configuration macros. All macros have default values if
left undefined, and can be overwritten by defining them with proper values
before including any of the library headers. Not all configuration macros are
documented here. Those not listed here are subject to change in future.

There are three types of configuration macros. The first type has a prefix
|MCKL_HAS_|. These macros specify that a certain feature or third-party library
is available. The second type has a prefix |MCKL_USE_|. These macros specify
that a certain feature or third-party library can be used, if available. These
two kinds of macros shall only be defined to integral values, with zero as
false and all other values as true. The third type affects implementation
choices made by the library. Their possible values vary with each specific
macro.

A concrete example of the relations among these three types of configuration
macros is the memory allocation functions used by the library. The details are
in section~\ref{sec:Aligned memory allocation}. In short, they library has
three implementations for aligned memory allocation. The preferred method is to
use functions from the \tbb library. It is defined through a class called
|AlignedMemoryTBB|. This class is only defined if and only if |MCKL_HAS_TBB| is
true, in which case the runtime library |tbbmalloc| needs to be linked as well
(|-ltbbmalloc| on \unix-alike systems). However, if it is desirable to define
this class such that the user can use it with \stl containers, but it is
undesirable for the library itself to use it everywhere, then one can further
define the macro |MCKL_USE_TBB_MALLOC| to zero. In this case, the class is
still defined, but it is not used by the library. Instead the library now
prefers operating system dependent memory allocation functions such as
|posix_memalign|. Now, suppose this is still undesirable, and one wants to use
a memory allocation function not directly supported by the library. In this
case, one can implement a aligned memory class (see section~\ref{sec:Aligned
memory allocation} for details), and then define the macro
|MCKL_ALIGNED_MEOMRY_TYPE| to this class. For example, to use the memory
allocation functions from the \mkl library,
\begin{verbatim}
#include <mkl.h>

class AlignedMemoryMKL
{
    public:
    static void *aligned_malloc(size_t n, size_t alignment)
    {
        return mkl_malloc(n > 0 ? n : 1, alignment);
    }

    static void aligned_free(void *ptr)
    {
        mkl_free(ptr);
    }
};

// Use a fully qualified name in macro
// This avoids any possible name conflicts
#define MCKL_ALIGNED_MEMORY_TYPE ::AlignedMemoryMKL

// Include MCKL headers
\end{verbatim}
In summary, the |MCKL_HAS_| macros affect what is \emph{defined} by the
library. The |MCKL_USE_| macros affect what is \emph{used} by the library. And
other macros give direct control of the library's implementations. In most
situations, it is sufficient to use the first two to configure the features of
the library. The third kind is for more advanced users. Below we details all
configuration macros.

\section{Platform characteristics}
\label{sec:Platform characteristics}

The following macros have default values that depend on the compiler, operating
system or \cpu types. Their default values are therefore platform dependent.
The library tries its best to determine the correct values. But in the case of
errors, define these macros to override the default values.

\paragraph{\texttt{MCKL\_REQUIRE\_ENDIANNESS\_NEUTURAL}} The implementations of
\rng{}s in the library by default assume little-endian. When used on a
big-endian platform, the output will be different. For example, |Philox4x64|
has an array of 64-bit unsigned integers as internal states. Each time a 32-bit
integer (its |result_type|) is required, the lower half of the each 64-bit
unsigned integer comes first. Then the higher half. On a big-endian platform,
they will be returned in a reversed order. This will not effect the quality of
the \rng in any way. If exact reproducibility is desired, then one can set this
macro to true. The library then will take care to make sure that the output of
\rng{}s are always the same regardless of endianness. Note that, there might be
a noticeable performance hit on big-endian platforms when this macro set to
true.

\paragraph{\texttt{MCKL\_HAS\_LITTLE\_ENDIAN}} Set this macro to true if it is
known at compile time that the platform is of little-endian. Note that, setting
this macro to false \emph{does not} indicate that the platform is of
big-endian. It merely tells the library it is unknown and the endianness shall
be detected at runtime if required.

\paragraph{\texttt{MCKL\_HAS\_BIG\_ENDIAN}} Set this macro to true if it is
known at compile time that the platform is of big-endian. Note that, setting
this macro to false \emph{does not} indicate that the platform is of
little-endian. It merely tells the library it is unknown and the endianness
shall be detected at runtime if required. Note that, if both this and the above
macro are true, then it is a compile-time error. A platform cannot be of both
little- and big-endian at the same time.

\paragraph{\texttt{MCKL\_HAS\_POSIX}} Determine if the operating system is
\posix compatible.

\section{Third-party libraries}
\label{sec:Third-party libraries}

The following macros determine if certain third-party libraries are available.
All macros with the prefix |MCKL_HAS_| are define to false by default. All
macros with the prefix |MCKL_USE_| are defined to true if and only if the
corresponding |MCKL_HAS_| macro is true. Otherwise it is defined to false,
unless stated otherwise.

\paragraph{\texttt{MCKL\_HAS\_OMP}} Determine if OpenMP is supported.

\paragraph{\texttt{MCKL\_USE\_OMP}} Allow the library to use OpenMP for
parallelization. Currently this macro has no affect. The use of OpenMP for
parallelization is explicitly through |SamplerEvalOMP| etc., see
section~\ref{sec:Programming models}.

\paragraph{\texttt{MCKL\_HAS\_HDF5}} Determine if the \hdf library is
available. The functions in section~\ref{sec:Store objects in HDF5 format} are
only defined if this macro is true. One can include the following header
directly to bypass this check,
\begin{verbatim}
#include <mckl/utility/hdf5.hpp>
\end{verbatim}

\paragraph{\texttt{MCKL\_HAS\_TBB}} Determine if the \tbb library is available.
The class template |RNGSetTBB| in section~\ref{sec:Multiple random number
  generators} and the class |AlignedMemoryTBB| in section~\ref{sec:Aligned
memory allocation} are only defined if this macro is true.

\paragraph{\texttt{MCKL\_USE\_TBB}} Allow the library to use the \tbb library
for parallelization. Currently this macro has no affect. The use of \tbb for
parallelization is explicitly through |SamplerEvalTBB| etc., see
section~\ref{sec:Programming models}.

\paragraph{\texttt{MCKL\_USE\_TBB\_MALLOC}} Allow the library to use
|AlignedMemoryTBB| as the default memory allocation method.

\paragraph{\texttt{MCKL\_USE\_TBB\_TLS}} Allow the library to use |RNGSetTBB|
as the default multiple \rng stream management method.

\paragraph{\texttt{MCKL\_HAS\_MKL}} Determine if the \mkl library is available.
The \rng{}s in section~\ref{sec:MKL random number generators} are only defined
if this macro is true. One can include the following header directly to bypass
this check,
\begin{verbatim}
#include <mckl/random/mkl.hpp>
\end{verbatim}

\paragraph{\texttt{MCKL\_USE\_MKL\_CBLAS}} Allow the library to use the
|mkl_cblas.h| header and assuming that corresponding runtime library is linked
for \blas support.

\paragraph{\texttt{MCKL\_USE\_MKL\_VML}} Allow the library to accelerate the
vector functions in section~\ref{sec:Vectorized functions} using the \vml
component of \mkl.

\paragraph{\texttt{MCKL\_USE\_MKL\_VSL}} Allow the library to use the \vsl
component of \mkl.

\paragraph{\texttt{MCKL\_USE\_CBLAS}} Allow the library to the standard C
interface of \blas. The default is true if and only if |MCKL_USE_MKL_CBLAS| is
true. Manually defining this macro to true if the header file |cblas.h| is
available and a compatible runtime library is linked. When this macro is tested
to be false, the library declares the \blas Fortran routines in C itself (see
below).

\paragraph{\texttt{MCKL\_BLAS\_NAME} and
\texttt{MCKL\_BLAS\_NAME\_NO\_UNDERSCORE}} These two macros determine how the
\blas Fortran routines are declared in C. The default behavior is to append an
underscore to the function name. For example, |dgemv| in Fortran becomes
|dgemv_| in C. If there should be no underscore, define the second macro. If
the name mangling is more complicated, one can define the |MCKL_BLAS_NAME|
macro directly. For example,
\begin{verbatim}
#define MCKL_BLAS_NAME(x) _##x
\end{verbatim}
These macros only have effects if |MCKL_USE_CBLAS| is false.

\paragraph{\texttt{MCKL\_BLAS\_INT}} The integer type of \blas routines. The
default is |MKL_INT| if |MCKL_USE_CBLAS| and |MCKL_USE_MKL_CBLAS| are both
true. Otherwise it is |int|. If the \blas interface uses another integer type,
such as the \ilp interface of some implementations on \lp platforms, then one
should redefine this macro to the correct type.

\section{Memory allocation}
\label{sec:Memory allocation}

\paragraph{\texttt{MCKL\_ALIGNMENT}} The default alignment for scalar types,
such as |int|. More specifically, this affects types such that
|std::is_scalar<T>| true. The default is~32. This is sufficient for modern
\simd operations. This affects the memory allocated by |Vector<T>| on the heap.
The value must be a power of two and positive.

\paragraph{\texttt{MCKL\_ALIGNMENT\_MIN}} The minimum alignment for all types.
The default is 16. The value must be a power of two and positive.

\paragraph{\texttt{MCKL\_MEMORY\_TYPE}} The default type of the |Memroy|
template parameter of |Allocator| (see section~\ref{sec:Aligned memory
  allocation}). The default depends on the other configuration macros. If
|MCKL_USE_TBB_MALLOC| is true, then the default is |AlignedMemoryTBB|.
Otherwise it is |AlignedMemorySYS| if it is defined. Otherwise
|AlignedMemmorySTD| is used as a last resort.

\section{Error handling}
\label{sec:Error handling}

\paragraph{\texttt{MCKL\_NO\_RUNTIME\_ASSERT}} Determine if all runtime
assertions shall be disabled. The default is true if and only if |NDEBUG| is
defined. Otherwise, it is false. Runtime assertions are hard errors. The
program is terminated by |std::exit| upon failure of assertions. These are
usually errors that cause undefined behaviors.

\paragraph{\texttt{MCKL\_RUNTIME\_ASSERT\_AS\_EXCEPTION}} Determine if runtime
assertions shall be turned into exceptions. The exception type is
|RuntimeAssert|. The default is false. This macro has no affect if
|MCKL_NO_RUNTIME_ASSERT| is true.
